<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voltes SmartInverter ‚Äî Live Dashboard</title>
<style>
:root {
  --bg: #f4f6f8;
  --panel: #fff;
  --accent: #00b894;
  --accent2: #00cec9;
  --border: #e5e7eb;
  --text: #1f2937;
  --muted: #6b7280;
  --radius: 10px;
  --shadow: 0 2px 6px rgba(0,0,0,0.05);
  --mono: ui-monospace, Menlo, Monaco, 'Roboto Mono', monospace;
}

html, body {
  margin: 0;
  height: 100%;
  background: var(--bg);
  font-family: "Inter", "Segoe UI", Roboto, sans-serif;
  color: var(--text);
}

.app {
  display: flex;
  height: 100vh;
  gap: 10px;
  padding: 8px;
  box-sizing: border-box;
}

/* --- Sidebar --- */
.sidebar {
  width: 240px;
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 8px;
  margin-bottom: 12px;
}

.logo {
  width: 38px;
  height: 38px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand h1 {
  font-size: 1rem;
  margin: 0;
}
.brand p {
  margin: 0;
  font-size: 0.75rem;
  color: var(--muted);
}

label.meta {
  font-size: 0.8rem;
  color: var(--muted);
  display: block;
  margin-bottom: 5px;
}

select#endpointSelect {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #fff;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
}
select#endpointSelect:focus {
  border-color: var(--accent);
  outline: none;
}

/* --- Controls --- */
.control-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}
.control-buttons button {
  aspect-ratio: 1/1;
  border: none;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.control-buttons button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
.control-buttons button:active {
  transform: scale(0.95);
}

/* --- Send Box --- */
.send-box {
  margin-top: 10px;
}
#msgInput {
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #fff;
  color: var(--text);
  font-size: 0.9rem;
  outline: none;
}
#msgInput:focus {
  border-color: var(--accent);
}
#sendBtn {
  margin-top: 6px;
  width: 100%;
  padding: 8px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(45deg, var(--accent), var(--accent2));
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}
#sendBtn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* --- Main --- */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.topbar {
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 8px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.topbar button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
}
.topbar button:hover {
  background: #00a884;
}

/* --- Feed --- */
.feed {
  flex: 1;
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 10px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}
.gauges {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 10px;
}
.gauges div {
  text-align: center;
  font-size: 0.85rem;
  color: var(--text);
}
/* .messages {
  flex: 1;
  overflow-y: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: #f9fafb;
  padding: 8px;
  font-family: var(--mono);
  font-size: 0.8rem;
} */
.empty {
  text-align: center;
  color: var(--muted);
  padding: 10px;
}

::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div>
      <div class="brand">
        <div class="logo">VT</div>
        <div><h1>Voltes</h1><p>SmartInverter Live</p></div>
      </div>
      <label class="meta" for="endpointSelect">Device</label>
      <select id="endpointSelect" disabled></select>
    </div>

    <div class="send-box">
      <label class="meta">Controls</label>
      <div class="control-buttons">
        <button id="changeBtn" title="Change">‚öôÔ∏è</button>
        <button id="powerBtn" title="Power">üîå</button>
        <button id="resetBtn" title="Reset">üîÑ</button>
        <button id="menuBtn" title="Menu">üìã</button>
      </div>
    </div>

    <div class="send-box">
      <label class="meta" for="msgInput">Send Message</label>
      <input id="msgInput" type="text" placeholder="Type message‚Ä¶" />
      <button id="sendBtn">Send</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div id="feedTitle">Selected: <span class="meta">‚Äî</span></div>
      <button id="clearBtn">üßπ Clear Feed</button>
    </div>

    <section class="feed">
      <div class="gauges">
        <div>
          <svg width="120" height="120" viewBox="0 0 36 36">
            <path d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831a15.9155 15.9155 0 0 1 0 -31.831"
              fill="none" stroke="#eee" stroke-width="2.5" />
            <path id="voltageArc" d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831a15.9155 15.9155 0 0 1 0 -31.831"
              fill="none" stroke="#00b894" stroke-width="2.5" stroke-dasharray="0,100" stroke-linecap="round" />
            <text x="18" y="20" font-size="4" text-anchor="middle" fill="#333" id="voltageLabel">0V</text>
          </svg>
          <div>Voltage</div>
        </div>
        <div>
          <svg width="120" height="120" viewBox="0 0 36 36">
            <path d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831a15.9155 15.9155 0 0 1 0 -31.831"
              fill="none" stroke="#eee" stroke-width="2.5" />
            <path id="currentArc" d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831a15.9155 15.9155 0 0 1 0 -31.831"
              fill="none" stroke="#0984e3" stroke-width="2.5" stroke-dasharray="0,100" stroke-linecap="round" />
            <text x="18" y="20" font-size="4" text-anchor="middle" fill="#333" id="currentLabel">0A</text>
          </svg>
          <div>Current</div>
        </div>
      </div>

      <!-- <div id="messages" class="messages">
        <div class="empty">No data yet</div>
      </div> -->
    </section>
  </main>
</div>

<script>
const select=document.getElementById('endpointSelect');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const feedTitle=document.getElementById('feedTitle');
const clearBtn=document.getElementById('clearBtn');
// const messagesEl=document.getElementById('messages');
let history=new Map(),ws,endpoints=[],selected=null;

function ensureEndpoint(n){if(!history.has(n))history.set(n,[]);}
function renderSelect(list){
  endpoints=Array.isArray(list)?list.slice():[];
  select.innerHTML='';
  endpoints.forEach(name=>{
    const opt=document.createElement('option');
    opt.value=name; opt.textContent=`üî¥ ${name}`; select.appendChild(opt);
    ensureEndpoint(name);
  });
  select.disabled=false;
  selected=endpoints[0]||null;
  if(selected)select.value=selected;
  feedTitle.querySelector('.meta').textContent=selected||'‚Äî';
}

function appendToHistory(endpoint,text){
  ensureEndpoint(endpoint);
  const arr=history.get(endpoint);
  arr.push({text,ts:new Date().toISOString(),endpoint});
  renderNewMessage({text,ts:new Date().toISOString(),endpoint});
}

function renderNewMessage(item){
  if(item.endpoint!==selected){updateGauges(0,0);return;}
  let data=item.text;
  if(typeof data==='string'&&(data.startsWith('{')||data.startsWith('['))){
    try{data=JSON.parse(data);}catch{}
  }
  if(data.voltage!==undefined&&data.current!==undefined){
    updateGauges(data.voltage,data.current);
  }
}

function sendMessage(){
  const text=msgInput.value.trim(); if(!text||!selected)return;
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({command:text,endpoint:selected}));
    appendToHistory(selected,"‚Üí "+text);
  }else appendToHistory(selected,"‚ö†Ô∏è WebSocket not connected");
  msgInput.value='';
}

function updateGauges(v,c){
  const max=420;
  document.getElementById('voltageArc').setAttribute('stroke-dasharray',`${Math.min(v/max,1)*100},100`);
  document.getElementById('voltageLabel').textContent=v.toFixed(1)+'V';
  document.getElementById('currentArc').setAttribute('stroke-dasharray',`${Math.min(c/max,1)*100},100`);
  document.getElementById('currentLabel').textContent=c.toFixed(1)+'A';
}

// function clearFeed(){messagesEl.innerHTML='<div class="empty">Feed cleared</div>'; history.clear();}
select.addEventListener('change',()=>{selected=select.value;feedTitle.querySelector('.meta').textContent=selected;});
sendBtn.addEventListener('click',sendMessage);
msgInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});
// clearBtn.addEventListener('click',clearFeed);

['change','power','reset','menu'].forEach(cmd=>{
  document.getElementById(cmd+'Btn').addEventListener('click',()=>{
    if(ws&&ws.readyState===WebSocket.OPEN&&selected){
      ws.send(JSON.stringify({command:cmd,endpoint:selected}));
    }
    appendToHistory(selected||'system',`üîò ${cmd}`);
  });
});

function openWS(){
  const url=(location.origin.replace(/^http/,'ws'));
  ws=new WebSocket(url);
  ws.onopen=()=>console.log('üü¢ Connected');
  ws.onclose=()=>setTimeout(openWS,3000);
  ws.onmessage=e=>{
    try{
      const obj=JSON.parse(e.data);
      if(obj.type==="status"&&Array.isArray(obj.data)){
        Array.from(select.options).forEach(opt=>{
          const ep=obj.data.find(e=>e.endpoint===opt.value);
          opt.textContent=`${ep?.online?"üü¢":"üî¥"} ${opt.value}`;
        });
        return;
      }
      if(obj.endpoint&&"body" in obj){
        appendToHistory(obj.endpoint,obj.body); return;
      }
    }catch(err){console.error("Parse error:",err);}
  }
}

fetch('/endpoints').then(r=>r.json()).then(list=>{
  renderSelect(list); openWS();
}).catch(()=>{renderSelect([]); openWS();});
</script>
</body>
</html>
